# Nitter X 使用指南

## 目录

1. [快速开始](#快速开始)
2. [用户管理](#用户管理)
3. [推文采集](#推文采集)
4. [数据查询](#数据查询)
5. [系统测试](#系统测试)
6. [常见问题](#常见问题)

---

## 快速开始

### 1. 启动基础服务

```bash
# 启动 PostgreSQL 和 Redis
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f
```

### 2. 安装 Python 依赖

```bash
# 激活虚拟环境（如果有）
source .venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

### 3. 测试系统

```bash
# 运行系统测试，验证数据库和爬虫功能
python test_system.py
```

---

## 用户管理

### 添加监听用户

#### 方式一：使用命令行工具（推荐）

```bash
# 添加单个用户
python manage_users.py add <username> --name "显示名称" --priority 优先级

# 示例：
python manage_users.py add elonmusk --name "Elon Musk" --priority 10
python manage_users.py add naval --name "Naval Ravikant" --priority 9
python manage_users.py add VitalikButerin --name "Vitalik Buterin" --priority 8
```

**参数说明**：
- `username`: X/Twitter 用户名（必填）
- `--name`: 显示名称（可选）
- `--priority`: 优先级，数字越大优先级越高（可选，默认 0）

**批量添加示例**：

```bash
# 加密货币 KOL
python manage_users.py add VitalikButerin --name "Vitalik Buterin" --priority 10
python manage_users.py add cz_binance --name "CZ" --priority 10
python manage_users.py add elonmusk --name "Elon Musk" --priority 9
python manage_users.py add balajis --name "Balaji Srinivasan" --priority 8
python manage_users.py add APompliano --name "Anthony Pompliano" --priority 7

# AI 领域
python manage_users.py add sama --name "Sam Altman" --priority 10
python manage_users.py add ylecun --name "Yann LeCun" --priority 9
python manage_users.py add karpathy --name "Andrej Karpathy" --priority 9

# 科技投资
python manage_users.py add naval --name "Naval Ravikant" --priority 10
python manage_users.py add chamath --name "Chamath Palihapitiya" --priority 8
python manage_users.py add paulg --name "Paul Graham" --priority 8
```

#### 方式二：直接操作数据库

适合批量添加大量用户：

```bash
# 连接到 PostgreSQL
docker-compose exec postgres psql -U nitter_user -d nitter_x
```

执行 SQL：

```sql
-- 批量添加用户
INSERT INTO watched_users (username, display_name, priority) VALUES
    ('elonmusk', 'Elon Musk', 10),
    ('naval', 'Naval Ravikant', 9),
    ('VitalikButerin', 'Vitalik Buterin', 8),
    ('cathiedwood', 'Cathie Wood', 7),
    ('balajis', 'Balaji Srinivasan', 6)
ON CONFLICT (username) DO NOTHING;

-- 查看所有用户
SELECT * FROM watched_users ORDER BY priority DESC;

-- 退出
\q
```

### 查看用户列表

```bash
python manage_users.py list
```

输出示例：
```
共有 5 个关注用户:

ID    用户名                显示名称                         优先级    状态      最后采集时间
----------------------------------------------------------------------------------------------------
1     elonmusk            Elon Musk                      10       活跃      2025-12-22 10:30:00
2     naval               Naval Ravikant                 9        活跃      2025-12-22 10:28:00
3     VitalikButerin      Vitalik Buterin                8        活跃      从未
```

### 启用/禁用用户

```bash
# 禁用用户（不删除，暂停采集）
python manage_users.py disable elonmusk

# 重新启用用户
python manage_users.py enable elonmusk
```

### 删除用户

```bash
# 永久删除用户（谨慎使用）
python manage_users.py remove elonmusk
```

---

## 推文采集

### 运行采集任务

```bash
# 执行一次采集
python main.py
```

**工作流程**：
1. 从数据库读取所有活跃的关注用户
2. 按优先级顺序遍历每个用户
3. 从 Nitter 实例获取用户最新推文
4. 与数据库中最新推文 ID 对比，只采集新推文
5. 去重后存入 PostgreSQL
6. 推送 tweet_id 到 Redis 处理队列（预留，v3.0.0 使用）
7. 更新用户的最后采集时间

**采集日志**：

日志保存在 `logs/crawler.log`，可以查看：

```bash
# 实时查看日志
tail -f logs/crawler.log

# 查看最近 50 行
tail -50 logs/crawler.log
```

### 定时采集（可选）

使用 cron 定时执行采集任务：

```bash
# 编辑 crontab
crontab -e

# 添加定时任务，每小时执行一次
0 * * * * cd /path/to/nitter_x && /path/to/python main.py >> logs/cron.log 2>&1

# 或每 30 分钟执行一次
*/30 * * * * cd /path/to/nitter_x && /path/to/python main.py >> logs/cron.log 2>&1
```

---

## 数据查询

### 使用 SQL 查询

```bash
# 连接数据库
docker-compose exec postgres psql -U nitter_user -d nitter_x
```

**常用查询**：

```sql
-- 1. 查看采集统计
SELECT
    author,
    COUNT(*) as tweet_count,
    MAX(published_at) as latest_tweet
FROM tweets
GROUP BY author
ORDER BY tweet_count DESC;

-- 2. 查看最新推文
SELECT
    tweet_id,
    author,
    LEFT(content, 100) as content_preview,
    published_at
FROM tweets
ORDER BY published_at DESC
LIMIT 20;

-- 3. 查看某个用户的推文
SELECT
    tweet_id,
    LEFT(content, 150) as content,
    published_at
FROM tweets
WHERE author = 'elonmusk'
ORDER BY published_at DESC
LIMIT 10;

-- 4. 按日期统计推文数量
SELECT
    DATE(published_at) as date,
    COUNT(*) as tweet_count
FROM tweets
GROUP BY DATE(published_at)
ORDER BY date DESC
LIMIT 7;

-- 5. 查看用户采集状态
SELECT
    username,
    display_name,
    priority,
    is_active,
    last_crawled_at,
    (SELECT COUNT(*) FROM tweets WHERE author = watched_users.username) as tweet_count
FROM watched_users
ORDER BY priority DESC;

-- 6. 查看今天采集的推文
SELECT
    author,
    COUNT(*) as count
FROM tweets
WHERE DATE(created_at) = CURRENT_DATE
GROUP BY author;
```

### 数据导出

```bash
# 导出所有推文到 CSV
docker-compose exec postgres psql -U nitter_user -d nitter_x -c "\COPY (SELECT * FROM tweets ORDER BY published_at DESC) TO STDOUT CSV HEADER" > tweets.csv

# 导出某个用户的推文
docker-compose exec postgres psql -U nitter_user -d nitter_x -c "\COPY (SELECT * FROM tweets WHERE author='elonmusk' ORDER BY published_at DESC) TO STDOUT CSV HEADER" > elonmusk_tweets.csv
```

---

## 系统测试

### 测试所有组件

```bash
python test_system.py
```

测试内容：
- PostgreSQL 连接
- Redis 连接
- Nitter 爬虫功能

### 测试单个模块

```python
# 测试爬虫
from src.crawler.nitter_crawler import NitterCrawler
crawler = NitterCrawler()
tweets = crawler.fetch_user_timeline("elonmusk", max_tweets=5)
print(f"获取到 {len(tweets)} 条推文")

# 测试数据库
from src.storage.postgres_client import get_postgres_client
pg = get_postgres_client()
users = pg.get_watched_users()
print(f"关注用户数: {len(users)}")

# 测试 Redis
from src.storage.redis_client import get_redis_client
redis = get_redis_client()
redis.push_to_queue("test_queue", {"test": "data"})
data = redis.pop_from_queue("test_queue", timeout=1)
print(f"Redis 测试数据: {data}")
```

---

## 常见问题

### 1. 如何查看服务状态？

```bash
# 查看 Docker 服务状态
docker-compose ps

# 查看服务日志
docker-compose logs postgres
docker-compose logs redis
```

### 2. 如何重置数据库？

```bash
# 停止服务并删除数据卷
docker-compose down -v

# 重新启动（会自动初始化数据库）
docker-compose up -d
```

### 3. 如何备份数据？

```bash
# 备份数据库
docker-compose exec postgres pg_dump -U nitter_user nitter_x > backup_$(date +%Y%m%d).sql

# 恢复数据库
cat backup_20251222.sql | docker-compose exec -T postgres psql -U nitter_user nitter_x
```

### 4. Nitter 实例不可用怎么办？

系统配置了多个 Nitter 实例（在 `.env` 中的 `NITTER_INSTANCES`），会自动轮询或重试。

如果都不可用，可以：
1. 在 `.env` 中添加更多可用实例
2. 查找最新的公共 Nitter 实例列表

```bash
# 编辑 .env 文件
nano .env

# 修改 NITTER_INSTANCES 行
NITTER_INSTANCES=https://xcancel.com,https://nuke.trabun.org,https://nitter.poast.org
```

### 5. 如何调整采集频率？

修改 `.env` 文件中的参数：

```bash
# 编辑 .env
nano .env

# 调整以下参数
CRAWLER_TIMEOUT=30        # 请求超时（秒）
CRAWLER_RETRY=3           # 重试次数
CRAWLER_DELAY=2.0         # 每个用户采集间隔（秒）
```

### 6. 查看 Redis 队列状态

```bash
# 连接 Redis
docker-compose exec redis redis-cli -a xin_x

# 查看处理队列长度
LLEN queue:process

# 查看队列内容
LRANGE queue:process 0 10

# 退出
exit
```

### 7. 清空所有数据

```bash
# 清空推文表
docker-compose exec postgres psql -U nitter_user -d nitter_x -c "TRUNCATE TABLE tweets, processing_logs;"

# 清空 Redis 队列
docker-compose exec redis redis-cli -a xin_x FLUSHDB
```

---

## 进阶使用

### 自定义配置

所有配置在 `.env` 文件中，可以根据需要修改：

```bash
# PostgreSQL 配置
POSTGRES_PORT=5433
POSTGRES_PASSWORD=your_password

# Redis 配置
REDIS_PASSWORD=your_redis_password

# Nitter 实例（多个用逗号分隔）
NITTER_INSTANCES=https://xcancel.com,https://nuke.trabun.org

# 日志级别
LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR

# 爬虫配置
CRAWLER_TIMEOUT=30
CRAWLER_RETRY=3
CRAWLER_DELAY=1.0
```

### 查看项目结构

```bash
# 查看目录结构
tree -L 3 -I '__pycache__|*.pyc|.git|.idea|.venv'

# 或查看文档
cat PROJECT_STRUCTURE.md
```

---

## 后续版本预告

- **v3.0.0**: 内容处理与分析
  - 文本清洗
  - LLM 标签系统
  - 权重与等级计算

- **v4.0.0**: 内容展示
  - Streamlit Web 界面
  - 多维度筛选
  - Webhook 推送

---

## 技术支持

如有问题或建议，请：
1. 查看 `README.md` 和 `DEPLOYMENT.md`
2. 查看日志文件 `logs/crawler.log`
3. 提交 Issue 到项目仓库
