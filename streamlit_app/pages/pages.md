# pages 目录

## 目录作用

存放 Streamlit 应用的多页面文件。

## 命名规范

- 文件命名格式：`序号_页面名.py`
- 序号决定页面在侧边栏的显示顺序
- 文件名遵循 Python 命名规范（小写字母 + 下划线）
- Streamlit 自动识别并生成导航

## 页面说明

### 1_Processed_Results.py (推文处理结果) - 默认首页

推文 LLM 处理结果展示页面，功能包括：
- **处理进度监控**（新增）：
  - 实时显示剩余待处理推文数量（`processing_status = 'pending'`）
  - 显示上一轮单条处理耗时（秒，自动从毫秒转换）
  - 支持手动刷新统计数据
- **统计概览**：
  - 按分级（P0-P6）显示推文数量
  - 分级说明和图例
- **筛选功能**：
  - 多选分级筛选
  - 默认显示 P0/P1/P2 级推文
- **推文展示**：
  - 分级标签（带颜色区分）
  - 作者和发布时间
  - **源推文链接**（x.com 原文链接）
  - **中文翻译**（如果原文是英文，优先显示翻译）
  - 原文内容（可折叠查看）
  - 中文摘要（P0/P1/P2级，≤30字）
  - 关键词标签（P0/P1/P2级）
  - **媒体资源**（P0/P1/P2级）：
    - 图片：自适应宽度显示
    - 视频：嵌入播放器
    - 多媒体：使用 expander 折叠展示，第一个默认展开
  - 处理耗时显示
- **排序方式**：按源推文发布时间降序（最新的在前）
- **分页浏览**：
  - 支持 10/20/50/100 条/页
  - 页码跳转
- **自动刷新**：
  - 可选 20 秒自动刷新（应用于整个页面）
  - 手动刷新按钮（仅刷新统计数据）

**分级标准（价格影响导向）**:
- 🔴 **P0级**: 价格驱动事件（已发生，必然触发资金行为）
- 🟠 **P1级**: 强信号事件（极可能发生，提前交易）
- 🟡 **P2级**: 结构性影响（改变价格中枢）
- 🟢 **P3级**: 宏观政策（影响风险资产定价）
- 🔵 **P4级**: 叙事情绪（资金反应不稳定）
- ⚪ **P5级**: 信息噪音（不改变资金决策）
- ⚫ **P6级**: 可舍弃（无价格影响）

**核心组件**：
- 处理进度监控卡片（剩余待处理数、处理耗时）
- 分级统计卡片
- 推文处理结果卡片
- 分页控制
- 筛选器

### 2_Tweets.py (推文展示)
推文展示页面，功能包括：
- 推文列表（卡片式展示，内容优先）
- **作者显示**：`@username (展示名)`格式
- **媒体展示**：
  - 图片：自适应宽度显示
  - 视频：嵌入播放器
  - 多媒体：使用 expander 折叠展示，第一个默认展开
- 多维筛选：
  - 按用户筛选
  - 按时间范围筛选（今天、最近3/7/30天、自定义）
  - 关键词搜索
- 分页浏览（每页 10/20/50/100 条）
- 数据导出（CSV，当前页/全部）
- 自动刷新（可选，侧边栏设置）
- **原始链接**：点击 🔗 原文跳转到 x.com

**页面布局**（自上而下）：
1. 顶部：推文总数 + 分页控制
2. 主体：推文卡片列表（直接展示）
3. 底部：分页控制 + 页码跳转
4. 筛选区域（折叠，默认收起）
5. 导出区域（折叠，默认收起）

**设计理念**：
- 内容优先：打开页面即可看到推文
- 筛选后置：不常用的筛选功能折叠在底部
- 状态持久：使用 session_state 保存筛选条件
- 媒体可选：通过 expander 控制是否加载媒体

**核心组件**：
- 推文卡片（头像、作者、时间、内容、媒体、原文链接）
- 媒体展示（图片/视频，可折叠）
- 筛选器组（折叠）
- 分页控制（顶部+底部）
- 导出按钮（折叠）

**推文卡片结构**：
```
┌────────────────────────────────────────┐
│ 👤 @username (Display Name) · 2小时前 🔗 │
│ 推文内容...                            │
│ 📷 媒体资源:                           │
│   ▼ 🖼️ 媒体 1 (默认展开)              │
│     [图片/视频展示]                    │
│   ▶ 🖼️ 媒体 2 (折叠)                  │
│ 📅 发布时间 | 💾 采集时间 | 🆔 ID      │
└────────────────────────────────────────┘
```

### 3_Users.py (用户管理)
用户管理页面，功能包括：
- 用户列表展示（AgGrid 表格，支持排序、筛选）
- 添加新用户（表单）
- 编辑用户信息（展示名称、优先级、备注）
- 启用/禁用用户（实时切换）
- 删除用户（带二次确认）
- 用户统计（推文数、最后采集时间）

**操作说明**：
- 在表格左侧勾选用户后，下方显示操作按钮
- 支持的操作：启用/禁用、编辑信息、删除

**核心组件**：
- 用户列表表格（AgGrid）
- 用户添加表单（折叠式）
- 用户编辑表单（选中后显示）
- 操作确认对话框

### 4_Monitor.py (系统监控)
系统监控页面，功能包括：
- 服务状态检查：
  - PostgreSQL 连接状态
  - Redis 连接状态
  - 爬虫运行状态
  - **处理 Worker 状态**（新增）
- 系统指标：
  - 监听用户数
  - 推文总数
  - 今日新增
  - **待处理推文数**（修正）
- 数据可视化：
  - 最近 30 天推文采集趋势图
  - 每日推文数量统计
- Nitter 实例：
  - 可用实例列表
  - 响应时间
- 系统配置：
  - 采集配置参数
  - 网络配置参数
- 自动刷新（10 秒）

**核心组件**：
- 服务状态卡片（4个：PostgreSQL、Redis、爬虫、处理 Worker）
- 系统指标卡片
- 趋势图表
- 实例列表
- 配置展示

## 页面开发规范

### 1. 页面配置
每个页面文件应包含：
```python
import streamlit as st

st.set_page_config(
    page_title="页面标题",
    page_icon="📝",
    layout="wide",  # 宽布局
)
```

### 2. 数据缓存
使用缓存减少数据库查询：
```python
@st.cache_data(ttl=60)  # 缓存 60 秒
def load_data():
    # 数据库查询
    return data
```

### 3. 会话状态
使用 `st.session_state` 管理状态：
```python
if "current_page" not in st.session_state:
    st.session_state.current_page = 1
```

### 4. 错误处理
使用 try-except 处理错误：
```python
try:
    data = load_data()
except Exception as e:
    st.error(f"❌ 加载数据失败: {str(e)}")
    st.info("💡 请确保数据库服务正常运行")
```

### 5. 加载状态
长时间操作显示加载状态：
```python
with st.spinner("正在加载数据..."):
    data = load_data()
```

## 添加新页面

1. 在 `pages/` 目录创建新文件
2. 文件命名：`序号_页面名.py`
3. 实现页面逻辑
4. 刷新 Streamlit，新页面自动出现

## 注意事项

- 页面文件名中的序号决定显示顺序
- 使用中文命名会直接显示在侧边栏
- 页面之间通过 `st.session_state` 共享状态
- 避免在页面中直接操作数据库，使用 `utils/db_helper.py`
- 使用 `utils/format_helper.py` 进行数据格式化
